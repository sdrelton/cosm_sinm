function S = sinm(A, schur_fact)
%SINM    Matrix sine function.
%
% This code computes the matrix sine of a given matrix A using
% either a Pade approximant or a rational approximant based 
% upon the exponential.
%
% The second (optional) argument SCHUR_FACT can be one of the following:
% 0 - No Schur decomposition used (this is the default).
% 1 - Real Schur decomposition used where possible.
% 2 - Always use the complex Schur decomposition.
%
% Please see the corresponding paper for when use of the Schur
% decomposition is beneficial but essentially it is:
% - potentially more accurate when A is nonnormal.
% - faster when A is sufficiently large and nonnormal.
%
% This code is intended for double precision arithmetic.
%
% Reference: A. H. Al-Mohy, N. J. Higham, and Samuel D. Relton,
% New Algorithms for the Matrix Sine and Cosine Separately or
% Simultaneously. SIAM J. Sci. Comput., 37(1), A456-A487, 2015.
%
% Corresponding algorithm from the paper: Algorithms 5.1 & 5.2
%
% Authors: A. H. Al-Mohy, N. J. Higham, and Samuel D. Relton.
% Date: September 30, 2015.

%% Check input parameters.
if nargin < 1
    error('sinm:NoInput', 'Not enough input parameters to sinm.')
end
if nargin < 2
    schur_fact = 0; % Default no Schur decomposition
end

if nargin == 2 && ~(schur_fact == 0 || schur_fact == 1 || schur_fact == 2)
    error('sinm:InvalidSchur', 'SCHUR_FACT argument is invalid.')
end

% Check matrix A is valid.
if ~ismatrix(A) || any(any(~isfinite(A))) || any(any(isnan(A)))
    error('sinm:NotMatrix', 'Input A must be a finite matrix.')
end

[rows, n] = size(A);
if rows ~= n
    error('sinm:Rectangular', 'Input matrix A must be square.')
end

%% Perform initialization.
useschur = false; % Use initial Schur decomposition.
transposed = false; % Do we need to transpose the matrix?
triang = true; % Will we be working on a triangular matrix?

if istril(A)
    transposed = true;
    T = transpose(A);
elseif istriu(A)
    T = A;
elseif schur_fact == 1
    useschur = true;
    [Q, T] = schur(A);
elseif schur_fact == 2
    useschur = true;
    [Q, T] = schur(A, 'complex');
else
    T = A; % Operate on full matrix
    triang = false;
end

%% Main computation
[s, approx_code, Tpowers] = parameter_selection(T); % Find optimal parameters
% Scaling down
for k = 2:2:length(Tpowers)
    Tpowers{k} = Tpowers{k}/3^(s*k);
end
T = T/3^s;

S = rational_approx(T, Tpowers, approx_code); % Rational approximation

if triang
    S = recompute_diag(S, T, 0); % Recompute 2x2 blocks on diagonal
end

I = eye(n);
% Do 'squaring' phase.
for k = 1:s
    S = S*(3*I -4*S^2);
    if triang
        S = recompute_diag(S, T, k); % Recompute 2x2 blocks on diagonal
    end
end

%% Finalize
if transposed
    S = transpose(S);
end

if useschur
    S = Q*S*Q';
end


end % of sinm

%% Subfunctions
function [s, approx_code, Tpowers] = parameter_selection(T)
    
th = [3.650024139523051e-08,...
    5.317232856892575e-04,...
    1.495585217958291e-02,...
    8.536352760102744e-02,...
    2.539398330063230e-01,...
    5.414660951208968e-01,...
    9.504178996162932e-01,...
    1.473163964234804e+00,...
    2.097847961257068e+00,...
    2.811644121620263e+00,...
    3.602330066265032e+00,...
    4.458935413036850e+00,...
    5.371920351148152e+00,...
    6.333131897833198e+00,...
    7.335666920593883e+00,...
    8.373706635544712e+00,...
    9.442353297358748e+00,...
    1.053748222747535e+01,...
    1.165561350236195e+01,...
    1.279380339874144e+01,...
    13];%13.736667272428120];
%1.394955385079727e+01,... reduce to keep cn < 10
    
b = [2.580956827951784e-08,...
    8.934541485594387e-03,...
    8.934541485594387e-03,...
    1.465548442258334e-01,...
    1.465548442258334e-01,...
    5.363750695219864e-01,...
    5.363750695219864e-01,...
    8.813735870195430e-01,...
    8.813735870195430e-01];

Tpowers = {};
s = 0;
d2 = normAm(T, 2)^(1/2);
a1 = d2;
if a1 <= b(1), approx_code = 'r1'; return; end
Tpowers{2} = T^2;
d2 = norm(Tpowers{2}, 1)^(1/2);
a1 = d2;
if a1 <= th(1), approx_code = 's1'; return; end
d4 = normAm(T, 4)^(1/4);
d6 = normAm(T, 6)^(1/6);
a2 = max(d4, d6);
if a2 <= b(3), approx_code = 'r3'; return; end
Tpowers{4} = Tpowers{2}^2;
d4 = norm(Tpowers{4}, 1)^(1/4);
a2 = max(d4, d6);
if a2 <= b(5), approx_code = 'r5'; return; end
Tpowers{6} = Tpowers{2}*Tpowers{4};
d6 = norm(Tpowers{6}, 1)^(1/6);
d8 = normAm(T, 8)^(1/8);
a3 = max(d6, d8);
if a3 <= b(7), approx_code = 'r7'; return; end
if a3 <= b(9), approx_code = 'r9'; return; end
if a3 <= 3*b(7), approx_code = 'r7'; s = 1; return; end
if a3 <= 3*b(9), approx_code = 'r9'; s = 1; return; end
if a3 <= th(10), approx_code = 's10'; return; end
if a3 <= 9*b(7), approx_code = 'r7'; s = 2; return; end
Tpowers{8} = Tpowers{4}^2;
d8 = norm(Tpowers{8}, 1)^(1/8);
a3 = max(d6, d8);
Tpowers{10} = Tpowers{4}*Tpowers{6};
d10 = norm(Tpowers{10}, 1)^(1/10);
a4 = max(d8, d10);
a34 = min(a3, a4);
if a34 <= th(12), approx_code = 's12'; return; end
if a3 <= 9*b(9), approx_code = 'r9'; s = 2; return; end
if a34 <= th(15), approx_code = 's15'; return; end
if a3 <= 3*th(10), approx_code = 's10'; s = 1; return; end
if a34 <= th(18), approx_code = 's18'; return; end;
if a34 <= 3*th(12), approx_code = 's12'; s = 1; return; end
d12 = normAm(T, 12)^(1/12);
a5 = max(d10, d12);
a345 = min([a3, a4, a5]);
if a345 <= th(21), approx_code = 's21'; return; end
% Else we need to scale
s = ceil(log(a345/th(21))/log(3));
a3 = a3/3^s;
a34 = a34/3^s;
a345 = a345/3^s;
if a3 <= 9*b(7), approx_code = 'r7'; s = s + 2; return; end
if a34 <= th(12), approx_code = 's12'; return; end
if a3 <= 9*b(9), approx_code = 'r9'; s = s + 2; return; end
if a34 <= th(15), approx_code = 's15'; return; end
if a3 <= 3*th(10), approx_code = 's10'; s = s + 1; return; end
if a34 <= th(18), approx_code = 's18'; return; end;
if a34 <= 3*th(12), approx_code = 's12'; s = s + 1; return; end
if a345 <= th(21), approx_code = 's21'; return;
else
    error('sinm:NoParam', 'Could not find parameters, please check A.')
end
end % of parameter_selection


function X = rational_approx(T, Tpowers, approx_code)
% RATIONAL_APPROX   Rational approximant to the matrix sine.
%
% This function computes the rational approximant to the matrix sine
% from either the Pade approximants of sin(x) or the Pade approximants of 
% the exponential.
    I = eye(length(T));
    switch approx_code
        case 'r1'
            X = T;
            return;
        case 'r3'
            p = [1 -7/60]; q = [1 1/20];
            P = T*(p(1)*I + p(2)*Tpowers{2});
            R = q(1)*I + q(2)*Tpowers{2};
        case 'r5'
            p = [1, -53/396, 551/166320];
            q = [1, 13/396, 5/11088];
            P = T*(p(1)*I + p(2)*Tpowers{2} + p(3)*Tpowers{4});
            R = q(1)*I + q(2)*Tpowers{2} + q(3)*Tpowers{4};
        case 'r7'
            p = [1, -29593/207636, 34911/7613320, -479249/11511339840];     
            q = [1, 1671/69212, 97/351384, 2623/1644477120];
            P = T*( p(1)*I +p(2)*Tpowers{2} +p(3)*Tpowers{4} +p(4)*Tpowers{6} );
            R = q(1)*I +q(2)*Tpowers{2} +q(3)*Tpowers{4} +q(4)*Tpowers{6};
        case 'r9'
            if size(Tpowers, 2) < 8
                Tpowers{8} = Tpowers{4}^2;
            end
            p = [1, -53272705/360869676, 38518909/7217393520, -269197963/3940696861920,...
                4585922449/15605159573203200];
            q = [1, 2290747/120289892, 1281433/7217393520, 560401/562956694560,...
                1029037/346781323848960];
            P = T*( p(1)*I + p(2)*Tpowers{2} + p(3)*Tpowers{4} + p(4)*Tpowers{6} + p(5)*Tpowers{8});
            R = q(1)*I + q(2)*Tpowers{2} + q(3)*Tpowers{4} + q(4)*Tpowers{6} + q(5)*Tpowers{8};
        case 's1'
            p = 1; q = [1 1/4];
            P = p(1)*T;
            R = q(1)*I + q(2)*Tpowers{2};
        case 's6'
            p = [1, -19/132, 421/87120, -1/18480, 1/4878720, -1/5269017600];
            q = [1, 1/44, 5/17424, 1/365904, 1/43908480, 1/5269017600, 1/442597478400];
            P = T*( p(1)*I + p(2)*Tpowers{2} + p(3)*Tpowers{4} + p(4)*Tpowers{6} +...
                Tpowers{6}*(p(5)*Tpowers{2} + p(6)*Tpowers{4}) );
            R = q(1)*I + q(2)*Tpowers{2} + q(3)*Tpowers{4} + q(4)*Tpowers{6} +...
                Tpowers{6}*(q(5)*Tpowers{2} + q(6)*Tpowers{4} + q(7)*Tpowers{6});
        case 's10'
            p = [1, -35/228, 9179/1472880, -89/859180, 205529/246082898880,...
                -2099/599869670400, 797/103945416486912, -2269/272856718278144000,...
                31/8107742485979136000, -1/2043151106466742272000];
            q = [1, 1/76, 9/98192, 1/2209320, 7/3906077760, 7/1145782809600,...
                7/371233630310400, 1/18190447885209600, 1/6306021933539328000,...
                1/2043151106466742272000, 1/449493243422683299840000];
            
            if size(Tpowers, 2) < 8
                Tpowers{8} = Tpowers{4}^2; Tpowers{10} = Tpowers{4}*Tpowers{6};
            end
            P = T*( p(1)*I + p(2)*Tpowers{2} + p(3)*Tpowers{4} + p(4)*Tpowers{6} +...
                p(5)*Tpowers{8} + p(6)*Tpowers{10} + Tpowers{10}*(p(7)*Tpowers{2} +...
                p(8)*Tpowers{4} + p(9)*Tpowers{6} + p(10)*Tpowers{8}) );
            R = q(1)*I + q(2)*Tpowers{2} + q(3)*Tpowers{4} + q(4)*Tpowers{6} + ...
                q(5)*Tpowers{8} + q(6)*Tpowers{10} + Tpowers{10}*(q(7)*Tpowers{2} +...
                q(8)*Tpowers{4} + q(9)*Tpowers{6} + q(10)*Tpowers{8} + q(11)*Tpowers{10});
        case 's12'
            p = [1, -43/276, 5851/888720, -2389/20262816, 932683/868059037440,...
                -1927/353653681920, 453053/28302196856693760, -42817/1564068773659392000,...
                42739/1616621484454347571200, -7753/581983734403565125632000, 103/34919024064213907537920000,...
                -1/5377529705888941760839680000];
            q = [1, 1/92, 11/177744, 5/20262816, 5/6430066944, 1/482255020800, 1/204200554521600,...
                1/94340656188979200, 1/46189185270124216320, 1/23279349376142605025280,...
                1/11639674688071302512640000, 1/5377529705888941760839680000, 1/1677789268237349829381980160000];
            Tpowers{12} = Tpowers{6}^2;
            P = T*( p(1)*I + p(2)*Tpowers{2} + p(3)*Tpowers{4} + p(4)*Tpowers{6} +...
                p(5)*Tpowers{8} + p(6)*Tpowers{10} + p(7)*Tpowers{12} +...
                Tpowers{12}*(p(8)*Tpowers{2} + p(9)*Tpowers{4} + p(10)*Tpowers{6} +...
                p(11)*Tpowers{8} + p(12)*Tpowers{10} ) );
            R = q(1)*I + q(2)*Tpowers{2} + q(3)*Tpowers{4} + q(4)*Tpowers{6} +...
                 q(5)*Tpowers{8} + q(6)*Tpowers{10} + q(7)*Tpowers{12} +...
                 Tpowers{12}*(q(8)*Tpowers{2} + q(9)*Tpowers{4} + q(10)*Tpowers{6} +...
                 q(11)*Tpowers{8} + q(12)*Tpowers{10} + q(13)*Tpowers{12});
        case 's14'
            p = [1, -6523045400347437/41440523719854304, 4531740124755535/663048379517668864,...
                 -5454326015402527/42435096289130807296, 3437258828262551/2715846162504371666944,...
                 -5008169319678469/695256617601119146737664, 8903123561070101/355971388211773003129683968,...
                 -1238462705053793/22782168845553472200299773952, 865933191260833/11664470448923377766553484263424,...
                 -373509187976925/5972208869848769416475383942873088, 741394528875/23888835479395077665901535771492352,...
                 -197915445/23888835479395077665901535771492352, 189735/191110683835160621327212286171938816,...
                 -105/3057770941362569941235396578751021056];
            q = [1, 6139336847385823/663048379517668864, 3783650560759263/84870192578261614592,...
                3239513523593215/21726769300034973335552, 4344033372589759/11124105881617906347802624,...
                4877511155188501/5695542211388368050074943488, 1197547495903059/729029403057711110409592766464,...
                265430440650375/93315763591387022132427874107392, 6805908734625/1493052217462192354118845985718272,...
                41247931725/5972208869848769416475383942873088, 241215975/23888835479395077665901535771492352,...
                348075/23888835479395077665901535771492352, 4095/191110683835160621327212286171938816,...
                105/3057770941362569941235396578751021056, 1/12231083765450279764941586315004084224];
            Tpowers{12} = Tpowers{6}^2; Tpowers{14} = Tpowers{6}*Tpowers{8};
            P = T*( p(1)*I + p(2)*Tpowers{2} + p(3)*Tpowers{4} + p(4)*Tpowers{6} +...
                p(5)*Tpowers{8} + p(6)*Tpowers{10} + p(7)*Tpowers{12} + p(8)*Tpowers{14} +...
                Tpowers{14}*(p(9)*Tpowers{2} + p(10)*Tpowers{4} + p(11)*Tpowers{6} +...
                p(12)*Tpowers{8} + p(13)*Tpowers{10}) + p(14)*Tpowers{12});
            R = q(1)*I + q(2)*Tpowers{2} + q(3)*Tpowers{4} + q(4)*Tpowers{6} +...
                q(5)*Tpowers{8} + q(6)*Tpowers{10} + q(7)*Tpowers{12} + q(8)*Tpowers{14} +...
                Tpowers{14}*(q(9)*Tpowers{2} + q(10)*Tpowers{4} + q(11)*Tpowers{6} +...
                q(12)*Tpowers{8} + q(13)*Tpowers{10} + q(14)*Tpowers{12} + q(15)*Tpowers{14});
        case 's15'
            p = [1, -55/348, 6299/908280, -33793/254318400, 425407/315863452800,...
                -57473/7188616512000, 45499733/1544761802263680000,...
                -613180093/8823679414530140160000, 646989529/6088338796025796710400000,...
                -332749/3176524589230850457600000, 6871/105811129420586260070400000,...
                -32479/1350150011406680678498304000000, 113/23320772924297211719516160000000,...
                -53/120055339014282045932069191680000000,...
                1/85719512056197380795497402859520000000];
            q = [1, 1/116, 7/181656, 13/108993600, 13/45123350400, 11/18951807168000,...
                11/10802530085760000, 11/6856005761095680000, 11/4730643975156019200000,...
                1/316277340053288140800000, 1/243533551841031868416000000,...
                1/192878573058097239785472000000, 1/153917101300361597348806656000000,...
                1/120055339014282045932069191680000000,...
                1/85719512056197380795497402859520000000,...
                1/41145365786974742781838753372569600000000];
            P = T*(p(1)*I + p(2)*Tpowers{2} + p(3)*Tpowers{4} + p(4)*Tpowers{6} +...
                p(5)*Tpowers{8} + p(6)*Tpowers{10} + Tpowers{10}*(p(7)*Tpowers{2} +...
                p(8)*Tpowers{4} + p(9)*Tpowers{6} + p(10)*Tpowers{8} + p(11)*Tpowers{10} +...
                Tpowers{10}*(p(12)*Tpowers{2} + p(13)*Tpowers{4} + p(14)*Tpowers{6} + p(15)*Tpowers{8})));
            R = q(1)*I + q(2)*Tpowers{2} + q(3)*Tpowers{4} + q(4)*Tpowers{6} +...
                q(5)*Tpowers{8} + q(6)*Tpowers{10} + Tpowers{10}*(q(7)*Tpowers{2} +...
                q(8)*Tpowers{4} + q(9)*Tpowers{6} + q(10)*Tpowers{8} + q(11)*Tpowers{10} +...
                Tpowers{10}*(q(12)*Tpowers{2} + q(13)*Tpowers{4} + q(14)*Tpowers{6} +...
                q(15)*Tpowers{8} + q(16)*Tpowers{10}));
        case 's16'
            p = [1, -59/372, 46973/6688560, -345661/2528275680, 12493951/8798399366400,...
                -194356861/22259950396992000, 1055570149/31252970357376768000,...
                -10619682023/124699351725933304320000, 966418763/6783644733890771755008000,...
                -104843/661173950671615180800000, 3422466701/29488503658223184819019776000000,...
                -7037431/129749416096182013203687014400000, 1192967/77849649657709207922212208640000000,...
                -14419/6072272673301318217932552273920000000, 541/3230449062196301291940117809725440000000,...
                -1/290740415597667116274610602875289600000000];
            q = [1, 1/124, 15/445904, 7/72236448, 91/418971398400, 13/32121140544000,...
                143/218552240261376000, 11/11626979181905203200, 11/8784828715217264640000,...
                11/7115711259325984358400000, 11/6078850475824198066176000000,...
                1/49036060504981864400486400000, 1/444855140901195473841212620800000,...
                1/404818178220087881195503484928000000, 1/358938784688477921326679756636160000000,...
                1/290740415597667116274610602875289600000000, 1/158162786085130911253388167964157542400000000];
            Tpowers{12} = Tpowers{6}^2;
            Tpowers{14} = Tpowers{6}*Tpowers{8}; Tpowers{16} = Tpowers{8}^2;
            P = T*( p(1)*I + p(2)*Tpowers{2} + p(3)*Tpowers{4} + p(4)*Tpowers{6} + p(5)*Tpowers{8} + ...
                p(6)*Tpowers{10} + p(7)*Tpowers{12} + p(8)*Tpowers{14} + p(9)*Tpowers{16} +...
                Tpowers{16}*(p(10)*Tpowers{2} + p(11)*Tpowers{4} + p(12)*Tpowers{6} + ...
                p(13)*Tpowers{8} + p(14)*Tpowers{10} + p(15)*Tpowers{12} + p(16)*Tpowers{14}) );
            R = q(1)*I + q(2)*Tpowers{2} + q(3)*Tpowers{4} + q(4)*Tpowers{6} +...
                q(5)*Tpowers{8} + q(6)*Tpowers{10} + q(7)*Tpowers{12} + q(8)*Tpowers{14} +...
                q(9)*Tpowers{16} +Tpowers{16}*(q(10)*Tpowers{2} + q(11)*Tpowers{4} + q(12)*Tpowers{6} +...
                q(13)*Tpowers{8} + q(14)*Tpowers{10} + q(15)*Tpowers{12} + q(16)*Tpowers{14}+...
                q(17)*Tpowers{16});
        case 's18'
            p = [1, -67/420, 4637/646800, -4307/30076200, 2670893/1726975404000,...
                -11663989/1160527471488000, 1176710621/28061554260579840000,...
                -1132533011/9681236219900044800000, 1552783049/6942326482051959398400000,...
                -73698940121/248273022390360405774336000000, 66147483473/241321377763430314412654592000000,...
                -15209/87056774084931570855936000000, 38181193/506774893303203660266574643200000000,...
                -3354257/158113766710599542003171288678400000000, 2405147/654590994181882103893129135128576000000000,...
                -7639/21601502808002109428473261459243008000000000, 227/14516209886977417535934031700611301376000000000,...
                -1/4935511361572321962217570778207842467840000000000];
            
            q = [1, 1/140, 17/646800, 1/15038100, 1/7675446240, 1/4736846822400, 13/44052675448320000,...
                13/35462403735897600000, 13/31413242000235110400000, 13/30081320539425141719040000,...
                13/30682946950213644553420800000, 1/2531343123392625675657216000000, 1/2820639480351782895732326400000000,...
                1/3226811565522439632717781401600000000, 1/3740519966753612022246452200734720000000,...
                1/4320300561600421885694652291848601600000000, 1/4838736628992472511978010566870433792000000000,...
                1/4935511361572321962217570778207842467840000000000, 1/3375889771315468222156818412294164248002560000000000];
            Tpowers{12} = Tpowers{6}^2;
            P = T*(p(1)*I + p(2)*Tpowers{2} + p(3)*Tpowers{4} + p(4)*Tpowers{6} +...
                p(5)*Tpowers{8} + p(6)*Tpowers{10} + p(7)*Tpowers{12} + ...
                Tpowers{12}*(p(8)*Tpowers{2} + p(9)*Tpowers{4} + p(10)*Tpowers{6} + ...
                p(11)*Tpowers{8} + p(12)*Tpowers{10} + p(13)*Tpowers{12} + ...
                Tpowers{12}*(p(14)*Tpowers{2} + p(15)*Tpowers{4} + p(16)*Tpowers{6} + ...
                p(17)*Tpowers{8} + p(18)*Tpowers{10})));
            R = q(1)*I + q(2)*Tpowers{2} + q(3)*Tpowers{4} + q(4)*Tpowers{6} +...
                q(5)*Tpowers{8} + q(6)*Tpowers{10} + q(7)*Tpowers{12} + ...
                Tpowers{12}*(q(8)*Tpowers{2} + q(9)*Tpowers{4} + q(10)*Tpowers{6} + ...
                q(11)*Tpowers{8} + q(12)*Tpowers{10} + q(13)*Tpowers{12} + ...
                Tpowers{12}*(q(14)*Tpowers{2} + q(15)*Tpowers{4} + q(16)*Tpowers{6} + ...
                q(17)*Tpowers{8} + q(18)*Tpowers{10} + q(19)*Tpowers{12}));
        case 's20'
            p = [1, -25/156, 32803/4502160, -28073/189090720, 610205/369407630592,...
                -2402893/214718185281600, 1666199/33745387054579200,...
                -4651693/31383209960758656000, 633860897/2034468891056114472960000,...
                -418416031039/896175408634654200880988160000, 503624642929/1000131756036274088183182786560000,...
                -118694179/303070229101901238843388723200000, 2534009941/11601528370020779422924920324096000000,...
                -296782559/3445653925896171488608701336256512000000, 2260549/96478309925092801681043637415182336000000,...
                -159017/37626540870786192655607018591921111040000000, 180007/379275531977524821968518747406564799283200000000,...
                -257/8596912058157229297953091607882135450419200000000, 37/1148103739379707396565348363117162605314048000000000,...
                -1/133894154293940236002244056803449737356934905856000000000];
    
            q = [1, 1/156, 19/900432, 1/21010080, 17/205226461440, 17/143145456854400,...
                17/116234110965772800, 1/6276641992151731200, 1/6373205715107911680000,...
                1/7036019109479134494720000, 1/8328088073219848283750400000,...
                1/10443422443817689747823001600000, 1/13729619372805656121804639436800000,...
                1/18740930443879720606263332831232000000, 1/26312266343207127731193719295049728000000,...
                1/37626540870786192655607018591921111040000000,...
                1/54182218853932117424074106772366399897600000000,...
                1/77372208523415063681577824470939219053772800000000,...
                1/106773647762312787880577397769896122294206464000000000,...
                1/133894154293940236002244056803449737356934905856000000000,...
                1/112471089606909798241885007714897779379825320919040000000000];
            Tpowers{12} = Tpowers{6}^2;
            Tpowers{14} = Tpowers{6}*Tpowers{8}; Tpowers{16} = Tpowers{8}^2;
            Tpowers{18} = Tpowers{8}*Tpowers{10}; Tpowers{20} = Tpowers{10}^2;
            P = T*( p(1)*I + p(2)*Tpowers{2} + p(3)*Tpowers{4} + p(4)*Tpowers{6} +...
                p(5)*Tpowers{8} + p(6)*Tpowers{10} + p(7)*Tpowers{12} + p(8)*Tpowers{14} +...
                p(9)*Tpowers{16} + p(10)*Tpowers{18} + p(11)*Tpowers{20} +...
                Tpowers{20}*(p(12)*Tpowers{2} + p(13)*Tpowers{4} + ...
                p(14)*Tpowers{6} + p(15)*Tpowers{8} + p(16)*Tpowers{10} + ...
                p(17)*Tpowers{12} + p(18)*Tpowers{14} + p(19)*Tpowers{16} +...
                p(20)*Tpowers{18}) );
            R = q(1)*I + q(2)*Tpowers{2} + q(3)*Tpowers{4} + q(4)*Tpowers{6} +...
                 q(5)*Tpowers{8} + q(6)*Tpowers{10} + q(7)*Tpowers{12} + q(8)*Tpowers{14} +...
                 q(9)*Tpowers{16} + q(10)*Tpowers{18} + q(11)*Tpowers{20} + Tpowers{20}*(q(12)*Tpowers{2} + ...
                 q(13)*Tpowers{4} + q(14)*Tpowers{6} + q(15)*Tpowers{8} + q(16)*Tpowers{10} +...
                 q(17)*Tpowers{12} + q(18)*Tpowers{14}+ q(19)*Tpowers{16} + q(20)*Tpowers{18} +...
                 q(21)*Tpowers{20});
        case 's21'
            p = [1, -79/492, 9619/1311180, -2457097/16300589760, 12953921/7628676007680,...
                -2182381/186478746854400, 21791569/412504307952422400,...
                -820705411/5024302470860504832000, 465129199/1304491623343418345472000,...
                -27502148371/49074974870179398156656640000,...
                91394031623/142418463836488271062273843200000,...
                -44229841/82202275148063256719232860160000,...
                221821296379/672488592758790696894372105682944000000,...
                -31231843/212987589495452772036927235817472000000,...
                1002641/21555029104742291284666979597942784000000,...
                -99784771/9730802339044859977550061269695290408960000000,...
                24287/16106155595660457893875963480874963435520000000,...
                -6014027/43354227509286907349577440978549609076464025600000000,...
                2803/390188047583582166146196968806946481688176230400000000,...
                -307/1779257496981134677626658177759675956498083610624000000000,...
                1/818458448611321951708262761769450939989118460887040000000000];
            q = [1, 1/164, 5/262236, 19/465731136, 19/282543555840, 17/186478746854400,...
                17/160418341981497600, 17/156311632426771261440, 17/168816563020912962355200,...
                1/11687300516832435855360000, 1/14784435153793031357030400000,...
                1/19870280846697834143848857600000, 1/28088629004892058345744745103360000,...
                1/41383913400540965962730591118950400000, 1/63007008152323620678257324978601984000000,...
                1/98290932717624848258081426966619095040000000,...
                1/155692837424717759640800980315124646543360000000,...
                1/247738442910210899140442519877426337579794432000000,...
                1/390188047583582166146196968806946481688176230400000000,...
                1/593085832327044892542219392586558652166027870208000000000,...
                1/818458448611321951708262761769450939989118460887040000000000,...
                1/756255606516861483378434791874972668549945457859624960000000000];
            Tpowers{12} = Tpowers{6}^2; Tpowers{14} = Tpowers{6}*Tpowers{8};
            P = T*(p(1)*I + p(2)*Tpowers{2} + p(3)*Tpowers{4} + p(4)*Tpowers{6} +...
                p(5)*Tpowers{8} + p(6)*Tpowers{10} + p(7)*Tpowers{12} +...
                p(8)*Tpowers{14} + Tpowers{14}*(p(9)*Tpowers{2} + p(10)*Tpowers{4} +...
                p(11)*Tpowers{6} + p(12)*Tpowers{8} + p(13)*Tpowers{10} +...
                p(14)*Tpowers{12} + p(15)*Tpowers{14} + Tpowers{14}*(p(16)*Tpowers{2} +...
                p(17)*Tpowers{4} + p(18)*Tpowers{6} + p(19)*Tpowers{8} +...
                p(20)*Tpowers{10} + p(21)*Tpowers{12})));
            R = q(1)*I + q(2)*Tpowers{2} + q(3)*Tpowers{4} + q(4)*Tpowers{6} +...
                q(5)*Tpowers{8} + q(6)*Tpowers{10} + q(7)*Tpowers{12} +...
                q(8)*Tpowers{14} + Tpowers{14}*(q(9)*Tpowers{2} + q(10)*Tpowers{4} +...
                q(11)*Tpowers{6} + q(12)*Tpowers{8} + q(13)*Tpowers{10} +...
                q(14)*Tpowers{12} + q(15)*Tpowers{14} + Tpowers{14}*(q(16)*Tpowers{2} +...
                q(17)*Tpowers{4} + q(18)*Tpowers{6} + q(19)*Tpowers{8} +...
                q(20)*Tpowers{10} + q(21)*Tpowers{12} + q(22)*Tpowers{14}));
        case 's22'
            p = [1, -83/516, 134303/18194160, -151805/993401136, 944319949/542516228392320,...
                -2907714977/238707140492620800, 2089317511/37238313916848844800,...
                -10791353051/60605355899671494912000, 101503414427/252686239306493197414809600,...
                -100343508571/152503577369683541498585088000, 4318528675729/5444377712097702431499487641600000,...
                -22709281687/32033199096760900352776055193600000, 7077025632431/15041508967875048369649524476706816000000,...
                -200084526553/866390916549602786091812609858312601600000, 312006366041/3760136577825276091638466726785076690944000000,...
                -151149637/7050256083422392671822125112722018795520000000, 3345677791/863628169194909412727523037807996414376017920000000,...
                -964705507/2055435042683884402291504829983031466214922649600000000, 1585799/44397396921971903089496504327633479670242329231360000000,...
                -252509/164492355595905900946584548533882042178247829802188800000000, 1009/32898471119181180189316909706776408435649565960437760000000000,...
                -1/5526943148022438271805240830738436617189127081353543680000000000];
            
            q = [1, 1/172, 21/1212944, 5/141914448, 95/1722273740928, 19/267909248588800,...
                323/4137590435205427200, 17/224464281109894425600, 17/256906851872977833246720,...
                17/321060162883544297891758080, 17/432196373112463477931212800000,...
                1/36448560799151086638865612800000, 1/55110223928316442997964806553600000,...
                1/87118241985882633091182766199930880000,...
                1/142835197638187125988165877560686673920000,...
                1/241034396014440775105029918383658762240000000,...
                1/415405564788316215838154419340065615380480000000,...
                1/72502117907720790204285884655486118737739776000000,...
                1/1268497054913482945414185837932385133435495120896000000,...
                1/2193231407945412012621127313785093895709971064029184000000,...
                1/3655385679909020021035212189641823159516618440048640000000000,...
                1/5526943148022438271805240830738436617189127081353543680000000000,...
                1/5593266465798707531066903720707297856595396606329786204160000000000];
            Tpowers{12} = Tpowers{6}^2;
            Tpowers{14} = Tpowers{6}*Tpowers{8}; Tpowers{16} = Tpowers{8}^2;
            Tpowers{18} = Tpowers{8}*Tpowers{10}; Tpowers{20} = Tpowers{10}^2;
            Tpowers{22} = Tpowers{10}*Tpowers{12};
            P = T*( p(1)*I + p(2)*Tpowers{2} + p(3)*Tpowers{4} + p(4)*Tpowers{6} +...
                p(5)*Tpowers{8} + p(6)*Tpowers{10} + p(7)*Tpowers{12} +...
                p(8)*Tpowers{14} + p(9)*Tpowers{16} + p(10)*Tpowers{18} +...
                p(11)*Tpowers{20} + p(12)*Tpowers{22} +...
                Tpowers{22}*(p(13)*Tpowers{2} + p(14)*Tpowers{4} + p(15)*Tpowers{6} +...
                p(16)*Tpowers{8} + p(17)*Tpowers{10} + p(18)*Tpowers{12} +...
                p(19)*Tpowers{14} + p(20)*Tpowers{16} + p(21)*Tpowers{18} +...
                p(22)*Tpowers{20}) );
            R = q(1)*I + q(2)*Tpowers{2} + q(3)*Tpowers{4} + q(4)*Tpowers{6} +...
                q(5)*Tpowers{8} + q(6)*Tpowers{10} + q(7)*Tpowers{12} + q(8)*Tpowers{14} +...
                q(9)*Tpowers{16} + q(10)*Tpowers{18} + q(11)*Tpowers{20} + q(12)*Tpowers{22} + ...
                Tpowers{22}*(q(13)*Tpowers{2} + q(14)*Tpowers{4} + q(15)*Tpowers{6} + ...
                q(16)*Tpowers{8} + q(17)*Tpowers{10} + q(18)*Tpowers{12} + q(19)*Tpowers{14} +...
                q(20)*Tpowers{16} + q(21)*Tpowers{18} + q(22)*Tpowers{20} + q(23)*Tpowers{22});
    end
    
    X = R\P;
end % of rational_approx


function Y = recompute_tbt(pos, depth, T)
% RECOMPUTE_TBT Recomputes a 2x2 diagonal block of the matrix.
%
% This function is called by recompute_diag to recompute the 2x2 diagonal
% blocks of a (quasi-)triangular matrix sine to high accuracy.
% This generally increases the accuracy of the overall computation for
% nonnormal matrices.

    Y = 3^(depth) .* T(pos:pos+1, pos:pos+1);
    if isequal(Y, triu(Y))
        % Upper-tri block
        l1 = Y(1,1); l2 = Y(2,2); y = Y(1,2);
        if l1 == l2
            Y = [sin(l1) y*cos(l1)
                 0        sin(l2)];
        else 
            Y = [sin(l1) y*(sin((l1-l2)/2)*cos((l1+l2)/2))/((l1-l2)/2)
                0        sin(l2)];
        end
        
    else
        % 2x2 block
        th = sqrt(-Y(1,2)*Y(2,1));
        Y = [sin(Y(1,1))*cosh(th)         Y(1,2)*cos(Y(1,1))*sinh(th)/th
             Y(2,1)*cos(Y(1,1))*sinh(th)/th   sin(Y(2,2))*cosh(th)];
    end
end % of recompute_tbt


function S = recompute_diag(S, T, depth)
% RECOMPUTE_DIAG Recompute the 2x2 diagonal blocks of S to high accuracy.
%
% This function uses an explicit formula for the matrix sine of a 2x2
% matrix to accurately form the diagonal blocks of the (quasi-)triangular
% matrix S. This generally increases the accuracy of the overall
% computation for nonnormal matrices.

n = length(T);
j = 1;
        while j <= n-1
            if T(j+1,j) ~= 0
                S(j:j+1,j:j+1) = recompute_tbt(j, depth, T);
                j = j + 2; %Ignore next part of Schur block
            elseif j <= n-2 && T(j+2, j+1) ~= 0
                %Next block is Schur block so leave it
                j = j + 1;
            else
                S(j:j+1,j:j+1) = recompute_tbt(j, depth, T);
                j = j + 1; %On upper tri block so move to next bit
            end
        end
end % of recompute_diag
