function [C, S] = cosmsinm(A, schur_fact)
%COSMSINM    Computes the matrix cosine function.
%
% This code simultaneously computes the matrix sine and cosine of a given
% matrix A using a rational approximant based upon the exponential.
%
% The second (optional) argument SCHUR_FACT can be one of the following:
% 0 - No Schur decomposition used.
% 1 - Real Schur decomposition used where possible (this is the default).
% 2 - Always use the complex Schur decomposition.
%
% Please see the corresponding paper for when use of the Schur
% decomposition is beneficial but essentially it is:
% - potentially more accurate when A is nonnormal.
% - faster when A is sufficiently large and nonnormal.
%
% This code is intended for double precision arithmetic.
%
% Reference: A. H. Al-Mohy, N. J. Higham, and Samuel D. Relton,
% New Algorithms for the Matrix Sine and Cosine Separately or
% Simultaneously. SIAM J. Sci. Comput., 37(1), A456-A487, 2015.
%
% Corresponding algorithm from the paper: Algorithms 6.1 & 6.2
%
% Author: A. H. Al-Mohy, N. J. Higham, and Samuel D. Relton.
% Date: September 30, 2015.

%% Check input parameters.
if nargin < 1
    error('cosmsinm:NoInput', 'Not enough input parameters to cosmsinm.')
end
if nargin < 2
    schur_fact = 1; % Default uses Schur decomposition
end

if nargin == 2 && ~(schur_fact == 0 || schur_fact == 1 || schur_fact == 2)
    error('cosmsinm:InvalidSchur', 'SCHUR_FACT argument is invalid.')
end

% Check matrix A is valid.
if ~ismatrix(A) || any(any(~isfinite(A))) || any(any(isnan(A)))
    error('cosmsinm:NotMatrix', 'Input A must be a finite matrix.')
end

[rows, n] = size(A);
if rows ~= n
    error('cosmsinm:Rectangular', 'Input matrix A must be square.')
end

%% Perform initialization.
useschur = false; % Use initial Schur decomposition.
transposed = false; % Do we need to transpose the matrix?
triang = true; % Will we be working on a triangular matrix?

if istril(A)
    transposed = true;
    T = transpose(A);
elseif istriu(A)
    T = A;
elseif schur_fact == 1
    useschur = true;
    [Q, T] = schur(A);
elseif schur_fact == 2
    useschur = true;
    [Q, T] = schur(A, 'complex');
else
    T = A; % Operate on full matrix
    triang = false;
end

%% Main computation
[s, m, Tpowers] = parameter_selection(T); % Find optimal parameters

% Scaling down
for k = 2:2:length(Tpowers)
    Tpowers{k} = Tpowers{k}/2^(s*k);
end
T = T/(2^s);

[C, S] = rational_approx(T, Tpowers, m); % Rational approximation

if triang
    % Recompute 2x2 blocks on diagonal
    C = recompute_diag_cos(C, T, 0);
    S = recompute_diag_sin(S, T, 0);
end

% Do 'squaring' phase.
I = eye(n);
for k = 1:s
    Cold = C;
    C = I - 2*S^2;
    S = 2*Cold*S;
    if triang
        % Recompute 2x2 blocks on diagonal
        C = recompute_diag_cos(C,  T, k);
        S = recompute_diag_sin(S, T, k);
    end
end

%% Finalize
if transposed
    C = transpose(C);
    S = tranpose(S);
end

if useschur
    C = Q*C*Q';
    S = Q*S*Q';
end

end % of cosmsinm

%% Subfunctions
function [s, m, Tpowers] = parameter_selection(T)
% PARAMETER_SELECTION Chooses optimal parameters for the matrix cosine.
%
% This function selects the optimal parameters for:
% S - the number of scalings.
% M - the degree of rational approximant used.
%
% We also compute some values of T^k, stored in Tpowers,
% which are used later when forming the rational approximant.
    th = [3.650024139523051e-08,...
        5.317232856892575e-04,...
        1.495585217958291e-02,...
        8.536352760102744e-02,...
        2.539398330063230e-01,...
        5.414660951208968e-01,...
        9.504178996162932e-01,...
        1.473163964234804e+00,...
        2.097847961257068e+00,...
        2.811644121620263e+00,...
        3.602330066265032e+00,...
        4.458935413036850e+00,...
        5.371920351148152e+00,...
        6.333131897833198e+00,...
        7.335666920593883e+00,...
        8.373706635544712e+00,...
        9.442353297358748e+00,...
        1.053748222747535e+01,...
        1.165561350236195e+01,...
        1.279380339874144e+01,...
        13];%13.736667272428120];
    %1.394955385079727e+01,... reduce to keep cn < 10
    
    s = 0;
    Tpowers{2} = T^2;
    d2 = norm(Tpowers{2}^2, 1)^(1/2);
    a1 = d2;
    if a1 <= th(1), m = 1; return; end
    Tpowers{4} = Tpowers{2}^2;
    d4 = norm(Tpowers{4}, 1)^(1/4);
    d6 = normAm(T, 6)^(1/6);
    a2 = max(d4, d6);
    if a2 <= th(2), m = 2; return; end
    Tpowers{6} = Tpowers{2}*Tpowers{4};
    d6 = norm(Tpowers{6}, 1)^(1/6);
    a2 = max(d4, d6);
    if a2 <= th(3), m = 3; return; end
    if a2 <= th(4), m = 4; return; end
    if a2 <= th(5), m = 5; return; end
    d8 = normAm(T, 8)^(1/8);
    a3 = max(d6, d8);
    if a3 <= th(6), m = 6; return; end
    Tpowers{8} = Tpowers{4}^2;
    d8 = norm(Tpowers{8}, 1)^(1/8);
    a3 = max(d6, d8);
    if a3 <= th(8), m = 8; return; end
    Tpowers{10} = Tpowers{4}*Tpowers{6};
    if a3 <= th(10), m = 10; return; end
    Tpowers{12} = Tpowers{6}^2;
    d10 = norm(Tpowers{10}, 1)^(1/10);
    a4 = max(d8, d10);
    a34 = min(a3, a4);
    if a34 <= th(12), m = 12; return; end
    if a34 <= th(14), m = 14; return; end
    if a34 <= th(16), m = 16; return; end
    if a34 <= 2*th(12), m = 12; s = 1; return; end
    if a34 <= th(18), m = 18; return; end
    if a34 <= 2*th(14), m = 14; s = 1; return; end
    d12 = norm(Tpowers{12}, 1)^(1/12);
    a5 = max(d10, d12);
    a345 = min([a3, a4, a5]);
    if a345 <= th(21), m = 21; return; end
    % Else we need to scale
    s = ceil(log2(a345/th(21)));
    a34 = a34/2^s;
    a345 = a345/2^s;
    % This means a34, a345 > 7 at this point
    if a34 <= th(16), m = 16; return; end
    if a34 <= 2*th(12), m = 12; s = s + 1; return; end
    if a34 <= th(18), m = 18; return; end
    if a34 <= 2*th(14), s = s + 1; m = 14; return; end
    if a345 <= th(21), m = 21; return;
    else
        error('cosmsinm:NoParam', 'No parameters found, please check A.')
    end
end % of parameter_selection


function [X,Y] = rational_approx(T, Tpowers, m)
% RATIONAL_APPROX Rational approximants to the matrix cosine and sine.
%
% This function computes the rational approximants to the matrix cosine
% and sine based upon the Pade approximant to the exponential of degree M.
    % X = cos, Y = sin
    I = eye(length(T));
    switch m
        case 1
            p = [1 -1/4]; q = [1 1/4];
            P = p(1)*I + p(2)*Tpowers{2};
            P2 = T;
            R = q(1)*I + q(2)*Tpowers{2};
        case 2
            p = [1 -5/12 1/144]; 
            p2 = [1 -1/12];
            q = [1 1/12 1/144];
            P = p(1)*I + p(2)*Tpowers{2} + p(3)*Tpowers{4}; 
            P2 = T*(p2(1)*I + p2(2)*Tpowers{2});
            R = q(1)*I + q(2)*Tpowers{2} + q(3)*Tpowers{4};
        case 3
            p = [1 -9/20 11/600 -1/14400]; 
            p2 = [1 -7/60 1/600];
            q = [1 1/20 1/600 1/14400];
            P = p(1)*I + p(2)*Tpowers{2} + p(3)*Tpowers{4} + p(4)*Tpowers{6};
            P2 = T*(p2(1)*I + p2(2)*Tpowers{2} + p2(3)*Tpowers{4});
            R = q(1)*I + q(2)*Tpowers{2} + q(3)*Tpowers{4} + q(4)*Tpowers{6};
        case 4
            p = [1, -13/28, 289/11760, -19/70560, 1/2822400];
            p2 = [1, -11/84, 37/11760, -1/70560];
            q = [1, 1/28, 3/3920, 1/70560, 1/2822400];
            Tpowers{8} = Tpowers{4}^2;
            P = p(1)*I + p(2)*Tpowers{2} + p(3)*Tpowers{4} + p(4)*Tpowers{6} + p(5)*Tpowers{8};
            P2 = T*(p2(1)*I + p2(2)*Tpowers{2} + p2(3)*Tpowers{4} + p2(4)*Tpowers{6});
            R = q(1)*I + q(2)*Tpowers{2} + q(3)*Tpowers{4} + q(4)*Tpowers{6} + q(5)*Tpowers{8};
        case 5
            p = [1, -17/36, 16/567, -1/2240, 29/15240960, -1/914457600];    
            p2 = [1, -5/36, 47/11340, -19/544320, 1/15240960];
            q = [1, 1/36, 1/2268, 1/181440, 1/15240960, 1/914457600];
            Tpowers{8} = Tpowers{4}^2; Tpowers{10} = Tpowers{4}*Tpowers{6};
            P = p(1)*I + p(2)*Tpowers{2} + p(3)*Tpowers{4} + p(4)*Tpowers{6} +...
                p(5)*Tpowers{8} + p(6)*Tpowers{10};
            P2 = T*(p2(1)*I + p2(2)*Tpowers{2} + p2(3)*Tpowers{4} + p2(4)*Tpowers{6} +...
                p2(5)*Tpowers{8});
            R = q(1)*I + q(2)*Tpowers{2} + q(3)*Tpowers{4} + q(4)*Tpowers{6} + ...
                q(5)*Tpowers{8} + q(6)*Tpowers{10};
        case 6
            p = [1, -21/44, 533/17424, -533/914760, 169/43908480, -41/5269017600,...
                 1/442597478400];
            p2 = [1, -19/132, 421/87120, -1/18480, 1/4878720, -1/5269017600];
            q = [1, 1/44, 5/17424, 1/365904, 1/43908480, 1/5269017600, 1/442597478400];
            P = p(1)*I + p(2)*Tpowers{2} + p(3)*Tpowers{4} + p(4)*Tpowers{6} +...
                Tpowers{6}*(p(5)*Tpowers{2} + p(6)*Tpowers{4} + p(7)*Tpowers{6});
            P2 = T*( p2(1)*I + p2(2)*Tpowers{2} + p2(3)*Tpowers{4} + p2(4)*Tpowers{6} +...
                 Tpowers{6}*(p2(5)*Tpowers{2} + p2(6)*Tpowers{4}) );
            R = q(1)*I + q(2)*Tpowers{2} + q(3)*Tpowers{4} + q(4)*Tpowers{6} +...
                Tpowers{6}*(q(5)*Tpowers{2} + q(6)*Tpowers{4} + q(7)*Tpowers{6});
        case 8
            p = [1, -29/60, 1567/46800, -791/1029600, 9991/1349187840,...
                -499/15567552000, 529/8904639744000, -71/1869974346240000,...
                1/269276305858560000];
            p2 = [1, -3/20, 89/15600, -361/4324320, 18167/33729696000, -313/202378176000,...
                47/26713919232000, -1/1869974346240000];
            q = [1, 1/60, 7/46800, 1/1029600, 1/192741120, 1/40475635200,...
                1/8904639744000, 1/1869974346240000, 1/269276305858560000];
    
            P = p(1)*I + p(2)*Tpowers{2} + p(3)*Tpowers{4} + p(4)*Tpowers{6} +...
                p(5)*Tpowers{8} + Tpowers{8}*(p(6)*Tpowers{2} + ...
                p(7)*Tpowers{4} + p(8)*Tpowers{6} + p(9)*Tpowers{8});
            P2 = T*( p2(1)*I + p2(2)*Tpowers{2} + p2(3)*Tpowers{4} + p2(4)*Tpowers{6} +...
                p2(5)*Tpowers{8} + Tpowers{8}*(p2(6)*Tpowers{2} + ...
                p2(7)*Tpowers{4} + p2(8)*Tpowers{6} ) );
            R = q(1)*I + q(2)*Tpowers{2} + q(3)*Tpowers{4} + q(4)*Tpowers{6} +...
                q(5)*Tpowers{8} + Tpowers{8}*(q(6)*Tpowers{2} +...
                q(7)*Tpowers{4} + q(8)*Tpowers{6} + q(9)*Tpowers{8});
        case 10
            p = [1, -37/76, 10363/294576, -87/98192, 30749/3038060480, -362377/6187227171840,...
                462401/2598635412172800, -631/2273805985651200, 11449/56754197401853952000,...
                -109/2043151106466742272000, 1/449493243422683299840000];
            p2 = [1, -35/228, 9179/1472880, -89/859180, 205529/246082898880,...
                -2099/599869670400, 797/103945416486912, -2269/272856718278144000,...
                31/8107742485979136000, -1/2043151106466742272000];
            q = [1, 1/76, 9/98192, 1/2209320, 7/3906077760, 7/1145782809600,...
                7/371233630310400, 1/18190447885209600, 1/6306021933539328000,...
                1/2043151106466742272000, 1/449493243422683299840000];
            P = p(1)*I + p(2)*Tpowers{2} + p(3)*Tpowers{4} + p(4)*Tpowers{6} +...
                p(5)*Tpowers{8} + p(6)*Tpowers{10} + Tpowers{10}*(p(7)*Tpowers{2} +...
                p(8)*Tpowers{4} + p(9)*Tpowers{6} + p(10)*Tpowers{8} + p(11)*Tpowers{10});
            P2 = T*( p2(1)*I + p2(2)*Tpowers{2} + p2(3)*Tpowers{4} + p2(4)*Tpowers{6} +...
                p2(5)*Tpowers{8} + p2(6)*Tpowers{10} + Tpowers{10}*(p2(7)*Tpowers{2} + ...
                p2(8)*Tpowers{4} + p2(9)*Tpowers{6} + p2(10)*Tpowers{8}) );
            R = q(1)*I + q(2)*Tpowers{2} + q(3)*Tpowers{4} + q(4)*Tpowers{6} +...
                q(5)*Tpowers{8} + q(6)*Tpowers{10} + Tpowers{10}*(q(7)*Tpowers{2} +...
                q(8)*Tpowers{4} + q(9)*Tpowers{6} + q(10)*Tpowers{8} + q(11)*Tpowers{10});
        case 12
             p = [1, -45/92, 6451/177744, -97939/101314080, 1172939/96451004160, -8903/108507379680,...
                 105169/332967021843456, -40133/56604393713387520, 7411631/8083107422271737856000,...
                 -377521/581983734403565125632000, 1/4475076773576048640000, -31/1075505941177788352167936000,...
                 1/1677789268237349829381980160000];
             p2 = [1, -43/276, 5851/888720, -2389/20262816, 932683/868059037440,...
                 -1927/353653681920, 453053/28302196856693760, -42817/1564068773659392000,...
                 42739/1616621484454347571200, -7753/581983734403565125632000, 103/34919024064213907537920000,...
                 -1/5377529705888941760839680000];
             q = [1, 1/92, 11/177744, 5/20262816, 5/6430066944, 1/482255020800, 1/204200554521600,...
                 1/94340656188979200, 1/46189185270124216320, 1/23279349376142605025280,...
                 1/11639674688071302512640000, 1/5377529705888941760839680000, 1/1677789268237349829381980160000];
             P = p(1)*I + p(2)*Tpowers{2} + p(3)*Tpowers{4} + p(4)*Tpowers{6} +...
                 p(5)*Tpowers{8} + p(6)*Tpowers{10} + p(7)*Tpowers{12} + ...
                 Tpowers{12}*(p(8)*Tpowers{2} + p(9)*Tpowers{4} + p(10)*Tpowers{6} +...
                 p(11)*Tpowers{8} + p(12)*Tpowers{10} + p(13)*Tpowers{12});
             P2 = T*( p2(1)*I + p2(2)*Tpowers{2} + p2(3)*Tpowers{4} + p2(4)*Tpowers{6} + ...
                 p2(5)*Tpowers{8} + p2(6)*Tpowers{10} + p2(7)*Tpowers{12} +...
                 Tpowers{12}*(p2(8)*Tpowers{2} + p2(9)*Tpowers{4} + p2(10)*Tpowers{6} + ...
                 p2(11)*Tpowers{8} + p2(12)*Tpowers{10} ) );
             R = q(1)*I + q(2)*Tpowers{2} + q(3)*Tpowers{4} + q(4)*Tpowers{6} +...
                 q(5)*Tpowers{8} + q(6)*Tpowers{10} + q(7)*Tpowers{12} + ...
                 Tpowers{12}*(q(8)*Tpowers{2} + q(9)*Tpowers{4} + q(10)*Tpowers{6} +...
                 q(11)*Tpowers{8} + q(12)*Tpowers{10} + q(13)*Tpowers{12});
        case 14
            p = [1, -53/108, 10813/291600, -191/186300, 386611/28168560000,...
                -56869/558472320000, 748559/1661526535680000, -223596931/180985100952015360000,...
                46266251/21718212114241843200000, -199259/86872848456967372800000,...
                13459/9003186112812982272000000, -18959/34315643868986681929728000000,...
                1/9802410346948516577280000000, -1/139337933076444295468154880000000,...
                1/12231083765450280256194635366400000000];
            p2 = [1, -6523045400347437/41440523719854304, 4531740124755535/663048379517668864,...
                 -5454326015402527/42435096289130807296, 3437258828262551/2715846162504371666944,...
                 -5008169319678469/695256617601119146737664, 8903123561070101/355971388211773003129683968,...
                 -1238462705053793/22782168845553472200299773952, 865933191260833/11664470448923377766553484263424,...
                 -373509187976925/5972208869848769416475383942873088, 741394528875/23888835479395077665901535771492352,...
                 -197915445/23888835479395077665901535771492352, 189735/191110683835160621327212286171938816,...
                 -105/3057770941362569941235396578751021056];
            q = [1, 1/108, 13/291600, 1/6706800, 11/28168560000, 11/12844863360000,...
                11/6696455431680000, 1/351563910163200000, 1/219375879941836800000,...
                1/144788080761612288000000, 1/99035047240942804992000000,...
                1/68631287737973363859456000000, 1/46669275661821887424430080000000,...
                1/29121628012976857752844369920000000, 1/12231083765450280256194635366400000000];
            Tpowers{14} = Tpowers{6}*Tpowers{8};
            P = p(1)*I + p(2)*Tpowers{2} + p(3)*Tpowers{4} + p(4)*Tpowers{6} +...
                p(5)*Tpowers{8} + p(6)*Tpowers{10} + p(7)*Tpowers{12} + p(8)*Tpowers{14} +...
                Tpowers{14}*(p(9)*Tpowers{2} + p(10)*Tpowers{4} + p(11)*Tpowers{6} +...
                p(12)*Tpowers{8} + p(13)*Tpowers{10} + p(14)*Tpowers{12} + p(15)*Tpowers{14});
            P2 = T*( p2(1)*I + p2(2)*Tpowers{2} + p2(3)*Tpowers{4} + p2(4)*Tpowers{6} +...
                p2(5)*Tpowers{8} + p2(6)*Tpowers{10} + p2(7)*Tpowers{12} + p2(8)*Tpowers{14} +...
                Tpowers{14}*(p2(9)*Tpowers{2} + p2(10)*Tpowers{4} + p2(11)*Tpowers{6} +...
                p2(12)*Tpowers{8} + p2(13)*Tpowers{10}) + p2(14)*Tpowers{12});
            R = q(1)*I + q(2)*Tpowers{2} + q(3)*Tpowers{4} + q(4)*Tpowers{6} +...
                q(5)*Tpowers{8} + q(6)*Tpowers{10} + q(7)*Tpowers{12} + q(8)*Tpowers{14} +...
                Tpowers{14}*(q(9)*Tpowers{2} + q(10)*Tpowers{4} + q(11)*Tpowers{6} +...
                q(12)*Tpowers{8} + q(13)*Tpowers{10} + q(14)*Tpowers{12} + q(15)*Tpowers{14});
        case 16
            p = [1, -61/124, 50389/1337712, -386317/361182240, 43857917/2932799788800,...
                -239501861/2023631854272000, 1379660677/2404074642875136000,...
                -14852176919/8313290115062220288000, 124296591847/33918223669453858775040000,...
                -19505467/3898646398787799859200000, 235437703/52007942959829250121728000000,...
                -1726217573/648747080480910066018435072000000, 3037703/3113985986308368316888488345600000,...
                -419827/2024090891100439405977517424640000000, 72361/3230449062196301291940117809725440000000,...
                -271/290740415597667116274610602875289600000000,...
                1/158162786085130911253388167964157542400000000];
            p2 = [1, -59/372, 46973/6688560, -345661/2528275680, 12493951/8798399366400,...
                -194356861/22259950396992000, 1055570149/31252970357376768000,...
                -10619682023/124699351725933304320000, 966418763/6783644733890771755008000,...
                -104843/661173950671615180800000, 3422466701/29488503658223184819019776000000,...
                -7037431/129749416096182013203687014400000, 1192967/77849649657709207922212208640000000,...
                -14419/6072272673301318217932552273920000000, 541/3230449062196301291940117809725440000000,...
                -1/290740415597667116274610602875289600000000];
            q = [1, 1/124, 15/445904, 7/72236448, 91/418971398400, 13/32121140544000,...
                143/218552240261376000, 11/11626979181905203200, 11/8784828715217264640000,...
                11/7115711259325984358400000, 11/6078850475824198066176000000,...
                1/49036060504981864400486400000, 1/444855140901195473841212620800000,...
                1/404818178220087881195503484928000000, 1/358938784688477921326679756636160000000,...
                1/290740415597667116274610602875289600000000, 1/158162786085130911253388167964157542400000000];
            Tpowers{14} = Tpowers{6}*Tpowers{8}; Tpowers{16} = Tpowers{8}^2;
            P = p(1)*I + p(2)*Tpowers{2} + p(3)*Tpowers{4} + p(4)*Tpowers{6} +...
                p(5)*Tpowers{8} + p(6)*Tpowers{10} + p(7)*Tpowers{12} + p(8)*Tpowers{14} +...
                p(9)*Tpowers{16} + Tpowers{16}*(p(10)*Tpowers{2} + p(11)*Tpowers{4} + p(12)*Tpowers{6} +...
                p(13)*Tpowers{8} + p(14)*Tpowers{10} + p(15)*Tpowers{12} + p(16)*Tpowers{14}+...
                p(17)*Tpowers{16});
            P2 = T*( p2(1)*I + p2(2)*Tpowers{2} + p2(3)*Tpowers{4} + p2(4)*Tpowers{6} + ...
                p2(5)*Tpowers{8} + p2(6)*Tpowers{10} + p2(7)*Tpowers{12} + p2(8)*Tpowers{14} +...
                p2(9)*Tpowers{16} + Tpowers{16}*(p2(10)*Tpowers{2} + p2(11)*Tpowers{4} + ...
                p2(12)*Tpowers{6} + p2(13)*Tpowers{8} + p2(14)*Tpowers{10} + ...
                p2(15)*Tpowers{12} + p2(16)*Tpowers{14}) );
            R = q(1)*I + q(2)*Tpowers{2} + q(3)*Tpowers{4} + q(4)*Tpowers{6} +...
                q(5)*Tpowers{8} + q(6)*Tpowers{10} + q(7)*Tpowers{12} + q(8)*Tpowers{14} +...
                q(9)*Tpowers{16} +Tpowers{16}*(q(10)*Tpowers{2} + q(11)*Tpowers{4} + q(12)*Tpowers{6} +...
                q(13)*Tpowers{8} + q(14)*Tpowers{10} + q(15)*Tpowers{12} + q(16)*Tpowers{14}+...
                q(17)*Tpowers{16});
        case 18
            p = [1, -69/140, 8219/215600, -671/607600, 2193/137552800, -21920323/165789638784000,...
                134249447/196234645178880000, -3751133521/1613539369983340800000,...
                24063924851/4492093606033620787200000, -3117272252947/365638451156712597594931200000,...
                2278348165637/241321377763430314412654592000000, -181116301/24964280458285894594412544000000,...
                118410671/31027034283869611853055590400000000, -12439657/9300809806505855411951252275200000000,...
                3548761/11901654439670583707147802456883200000000, -211369/5400375702000527357118315364810752000000000,...
                12769/4838736628992472511978010566870433792000000000, -1/14473640356517073202984078528468746240000000000,...
                1/3375889771315468222156818412294164248002560000000000];
            p2 = [1, -67/420, 4637/646800, -4307/30076200, 2670893/1726975404000,...
                -11663989/1160527471488000, 1176710621/28061554260579840000,...
                -1132533011/9681236219900044800000, 1552783049/6942326482051959398400000,...
                -73698940121/248273022390360405774336000000, 66147483473/241321377763430314412654592000000,...
                -15209/87056774084931570855936000000, 38181193/506774893303203660266574643200000000,...
                -3354257/158113766710599542003171288678400000000, 2405147/654590994181882103893129135128576000000000,...
                -7639/21601502808002109428473261459243008000000000, 227/14516209886977417535934031700611301376000000000,...
                -1/4935511361572321962217570778207842467840000000000];
            q = [1, 1/140, 17/646800, 1/15038100, 1/7675446240, 1/4736846822400, 13/44052675448320000,...
                13/35462403735897600000, 13/31413242000235110400000, 13/30081320539425141719040000,...
                13/30682946950213644553420800000, 1/2531343123392625675657216000000, 1/2820639480351782895732326400000000,...
                1/3226811565522439632717781401600000000, 1/3740519966753612022246452200734720000000,...
                1/4320300561600421885694652291848601600000000, 1/4838736628992472511978010566870433792000000000,...
                1/4935511361572321962217570778207842467840000000000, 1/3375889771315468222156818412294164248002560000000000];
            Tpowers{14} = Tpowers{6}*Tpowers{8}; Tpowers{16} = Tpowers{8}^2;
            Tpowers{18} = Tpowers{8}*Tpowers{10};
            P = p(1)*I + p(2)*Tpowers{2} + p(3)*Tpowers{4} + p(4)*Tpowers{6} +...
                p(5)*Tpowers{8} + p(6)*Tpowers{10} + p(7)*Tpowers{12} + p(8)*Tpowers{14} +...
                p(9)*Tpowers{16} + p(10)*Tpowers{18} + Tpowers{18}*(p(11)*Tpowers{2} + ...
                p(12)*Tpowers{4} + p(13)*Tpowers{6} + p(14)*Tpowers{8} + ...
                p(15)*Tpowers{10} + p(16)*Tpowers{12} + p(17)*Tpowers{14}+...
                p(18)*Tpowers{16} + p(19)*Tpowers{18});
            P2 = T*( p2(1)*I + p2(2)*Tpowers{2} + p2(3)*Tpowers{4} + p2(4)*Tpowers{6} + p2(5)*Tpowers{8} + ...
                p2(6)*Tpowers{10} + p2(7)*Tpowers{12} + p2(8)*Tpowers{14} + p2(9)*Tpowers{16} + p2(10)*Tpowers{18}+...
                Tpowers{18}*(p2(11)*Tpowers{2} + p2(12)*Tpowers{4} + p2(13)*Tpowers{6} + ...
                p2(14)*Tpowers{8} + p2(15)*Tpowers{10} + p2(16)*Tpowers{12} + p2(17)*Tpowers{14} +...
                p2(18)*Tpowers{16}) );
            R = q(1)*I + q(2)*Tpowers{2} + q(3)*Tpowers{4} + q(4)*Tpowers{6} +...
                 q(5)*Tpowers{8} + q(6)*Tpowers{10} + q(7)*Tpowers{12} + q(8)*Tpowers{14} +...
                 q(9)*Tpowers{16} + q(10)*Tpowers{18} + Tpowers{18}*(q(11)*Tpowers{2} + ...
                 q(12)*Tpowers{4} + q(13)*Tpowers{6} + q(14)*Tpowers{8} + q(15)*Tpowers{10} +...
                 q(16)*Tpowers{12} + q(17)*Tpowers{14}+ q(18)*Tpowers{16} + q(19)*Tpowers{18});
            
        case 20
            p = [ 1, -77/156, 34651/900432, -71369/63030240, 3438353/205226461440,...
                -41212637/286290913708800, 272617277/348702332897318400,...
                -480551/169638972760857600, 587885773/82851674296402851840000,...
                -254140763593/20214482901533553403330560000, 79870629226417/5000658780181370440915913932800000,...
                -11864985343/810917640029411422851229286400000, 22385977129/2320305674004155884584984064819200000,...
                -1002641/221081756597492166861545668608000000, 431594399/289434929775278405043130912245547008000000,...
                -48281/145276219578325068168366867150274560000000, 136219/2851695729154321969688110882756126310400000000,...
                -316133/77372208523415063681577824470939219053772800000000,...
                19321/106773647762312787880577397769896122294206464000000000,...
                -419/133894154293940236002244056803449737356934905856000000000,...
                1/112471089606909798241885007714897779379825320919040000000000];
            p2 = [1, -25/156, 32803/4502160, -28073/189090720, 610205/369407630592,...
                -2402893/214718185281600, 1666199/33745387054579200,...
                -4651693/31383209960758656000, 633860897/2034468891056114472960000,...
                -418416031039/896175408634654200880988160000, 503624642929/1000131756036274088183182786560000,...
                -118694179/303070229101901238843388723200000, 2534009941/11601528370020779422924920324096000000,...
                -296782559/3445653925896171488608701336256512000000, 2260549/96478309925092801681043637415182336000000,...
                -159017/37626540870786192655607018591921111040000000, 180007/379275531977524821968518747406564799283200000000,...
                -257/8596912058157229297953091607882135450419200000000, 37/1148103739379707396565348363117162605314048000000000,...
                -1/133894154293940236002244056803449737356934905856000000000];
            q = [1, 1/156, 19/900432, 1/21010080, 17/205226461440, 17/143145456854400,...
                17/116234110965772800, 1/6276641992151731200, 1/6373205715107911680000,...
                1/7036019109479134494720000, 1/8328088073219848283750400000,...
                1/10443422443817689747823001600000, 1/13729619372805656121804639436800000,...
                1/18740930443879720606263332831232000000, 1/26312266343207127731193719295049728000000,...
                1/37626540870786192655607018591921111040000000,...
                1/54182218853932117424074106772366399897600000000,...
                1/77372208523415063681577824470939219053772800000000,...
                1/106773647762312787880577397769896122294206464000000000,...
                1/133894154293940236002244056803449737356934905856000000000,...
                1/112471089606909798241885007714897779379825320919040000000000];
            Tpowers{14} = Tpowers{6}*Tpowers{8}; Tpowers{16} = Tpowers{8}^2;
            Tpowers{18} = Tpowers{8}*Tpowers{10}; Tpowers{20} = Tpowers{10}^2;
            P = p(1)*I + p(2)*Tpowers{2} + p(3)*Tpowers{4} + p(4)*Tpowers{6} +...
                p(5)*Tpowers{8} + p(6)*Tpowers{10} + p(7)*Tpowers{12} + p(8)*Tpowers{14} +...
                p(9)*Tpowers{16} + p(10)*Tpowers{18} + p(11)*Tpowers{20} + ...
                Tpowers{20}*(p(12)*Tpowers{2} + p(13)*Tpowers{4} + p(14)*Tpowers{6} + ...
                p(15)*Tpowers{8} + p(16)*Tpowers{10} + p(17)*Tpowers{12} + p(18)*Tpowers{14}+...
                p(19)*Tpowers{16} + p(20)*Tpowers{18} + p(21)*Tpowers{20});
            P2 = T*( p2(1)*I + p2(2)*Tpowers{2} + p2(3)*Tpowers{4} + p2(4)*Tpowers{6} +...
                p2(5)*Tpowers{8} + p2(6)*Tpowers{10} + p2(7)*Tpowers{12} + p2(8)*Tpowers{14} +...
                p2(9)*Tpowers{16} + p2(10)*Tpowers{18} + p2(11)*Tpowers{20} +...
                Tpowers{20}*(p2(12)*Tpowers{2} + p2(13)*Tpowers{4} + ...
                p2(14)*Tpowers{6} + p2(15)*Tpowers{8} + p2(16)*Tpowers{10} + ...
                p2(17)*Tpowers{12} + p2(18)*Tpowers{14} + p2(19)*Tpowers{16} +...
                p2(20)*Tpowers{18}) );
            R = q(1)*I + q(2)*Tpowers{2} + q(3)*Tpowers{4} + q(4)*Tpowers{6} +...
                q(5)*Tpowers{8} + q(6)*Tpowers{10} + q(7)*Tpowers{12} + q(8)*Tpowers{14} +...
                q(9)*Tpowers{16} + q(10)*Tpowers{18} + q(11)*Tpowers{20} + Tpowers{20}*(q(12)*Tpowers{2} + ...
                q(13)*Tpowers{4} + q(14)*Tpowers{6} + q(15)*Tpowers{8} + q(16)*Tpowers{10} +...
                q(17)*Tpowers{12} + q(18)*Tpowers{14}+ q(19)*Tpowers{16} + q(20)*Tpowers{18} +...
                q(21)*Tpowers{20});
        case 21
            p = [1, -81/164, 2533/65559, -2664719/2328655680, 14500309/847630667520,...
                -2750939/18442952985600, 4772125081/5775060311333913600,...
                -7205555041/2344674486401568921600, 6718682653/844082815104564811776000,...
                -175147477/11902734627741789511680000, 7557092027/383208908708499621408460800000,...
                -511087362307/26455098062894992010006770483200000,...
                1118382752029/80698631131054883627324652681953280000,...
                -928111901/128093065287388704170356591558656000000,...
                40219969879/14743639907643727238712214044992864256000000,...
                -37692173/52036376144624919666043108394092462080000000,...
                6811163/51897612474905919880266993438374882181120000000,...
                -19097941/1238692214551054495702212599387131687898972160000000,...
                131/121026069349746329449812955585281166776729600000000,...
                -1/25335803850102306486488931290809460129267712000000000,...
                461/818458448611321951708262761769450939989118460887040000000000,...
                -1/756255606516861483378434791874972668549945457859624960000000000];
            p2 = [1, -79/492, 9619/1311180, -2457097/16300589760, 12953921/7628676007680,...
                -2182381/186478746854400, 21791569/412504307952422400,...
                -820705411/5024302470860504832000, 465129199/1304491623343418345472000,...
                -27502148371/49074974870179398156656640000,...
                91394031623/142418463836488271062273843200000,...
                -44229841/82202275148063256719232860160000,...
                221821296379/672488592758790696894372105682944000000,...
                -31231843/212987589495452772036927235817472000000,...
                1002641/21555029104742291284666979597942784000000,...
                -99784771/9730802339044859977550061269695290408960000000,...
                24287/16106155595660457893875963480874963435520000000,...
                -6014027/43354227509286907349577440978549609076464025600000000,...
                2803/390188047583582166146196968806946481688176230400000000,...
                -307/1779257496981134677626658177759675956498083610624000000000,...
                1/818458448611321951708262761769450939989118460887040000000000];
            q = [1, 1/164, 5/262236, 19/465731136, 19/282543555840, 17/186478746854400,...
                17/160418341981497600, 17/156311632426771261440, 17/168816563020912962355200,...
                1/11687300516832435855360000, 1/14784435153793031357030400000,...
                1/19870280846697834143848857600000, 1/28088629004892058345744745103360000,...
                1/41383913400540965962730591118950400000, 1/63007008152323620678257324978601984000000,...
                1/98290932717624848258081426966619095040000000,...
                1/155692837424717759640800980315124646543360000000,...
                1/247738442910210899140442519877426337579794432000000,...
                1/390188047583582166146196968806946481688176230400000000,...
                1/593085832327044892542219392586558652166027870208000000000,...
                1/818458448611321951708262761769450939989118460887040000000000,...
                1/756255606516861483378434791874972668549945457859624960000000000];
            Tpowers{10} = Tpowers{4}*Tpowers{6}; Tpowers{12} = Tpowers{6}^2;
            Tpowers{14} = Tpowers{6}*Tpowers{8};
            
            P = p(1)*I + p(2)*Tpowers{2} + p(3)*Tpowers{4} + p(4)*Tpowers{6} +...
                p(5)*Tpowers{8} + p(6)*Tpowers{10} + p(7)*Tpowers{12} +...
                p(8)*Tpowers{14} + Tpowers{14}*(p(9)*Tpowers{2} + p(10)*Tpowers{4} +...
                p(11)*Tpowers{6} + p(12)*Tpowers{8} + p(13)*Tpowers{10} +...
                p(14)*Tpowers{12} + p(15)*Tpowers{14} + Tpowers{14}*(p(16)*Tpowers{2} +...
                p(17)*Tpowers{4} + p(18)*Tpowers{6} + p(19)*Tpowers{8} +...
                p(20)*Tpowers{10} + p(21)*Tpowers{12} + p(22)*Tpowers{14}));
            P2 = T*(p2(1)*I + p2(2)*Tpowers{2} + p2(3)*Tpowers{4} + p2(4)*Tpowers{6} +...
                p2(5)*Tpowers{8} + p2(6)*Tpowers{10} + p2(7)*Tpowers{12} +...
                p2(8)*Tpowers{14} + Tpowers{14}*(p2(9)*Tpowers{2} + p2(10)*Tpowers{4} +...
                p2(11)*Tpowers{6} + p2(12)*Tpowers{8} + p2(13)*Tpowers{10} +...
                p2(14)*Tpowers{12} + p2(15)*Tpowers{14} + Tpowers{14}*(p2(16)*Tpowers{2} +...
                p2(17)*Tpowers{4} + p2(18)*Tpowers{6} + p2(19)*Tpowers{8} +...
                p2(20)*Tpowers{10} + p2(21)*Tpowers{12})));
            R = q(1)*I + q(2)*Tpowers{2} + q(3)*Tpowers{4} + q(4)*Tpowers{6} +...
                q(5)*Tpowers{8} + q(6)*Tpowers{10} + q(7)*Tpowers{12} +...
                q(8)*Tpowers{14} + Tpowers{14}*(q(9)*Tpowers{2} + q(10)*Tpowers{4} +...
                q(11)*Tpowers{6} + q(12)*Tpowers{8} + q(13)*Tpowers{10} +...
                q(14)*Tpowers{12} + q(15)*Tpowers{14} + Tpowers{14}*(q(16)*Tpowers{2} +...
                q(17)*Tpowers{4} + q(18)*Tpowers{6} + q(19)*Tpowers{8} +...
                q(20)*Tpowers{10} + q(21)*Tpowers{12} + q(22)*Tpowers{14}));
        case 22
            p = [1, -85/172, 141103/3638832, -409871/354786120, 1050701797/60279580932480,...
                -3341543707/21700649135692800, 6466291103/7447662783369768960,...
                -2427179081/734610374541472665600, 4584567334709/520236375042780112324608000,...
                -2306590503461/136450569225506326603997184000, 43053585672743/1814792570699234143833162547200000,...
                -60536998217/2459692073501283419945304238080000,...
                398817815549/21037075479545522195314020247142400000,...
                -140882450641/13008872620864906698075264412286976000000,...
                17130334895477/3760136577825276091638466726785076690944000000,...
                -78508008521/56402048667379141374577000901776150364160000000,...
                316177639/1046822023266556863912149136736965350758809600000,...
                -377344067/8389530786464834295067366652991965168224174080000000,...
                56968943/13058057918227030320440148331656905785365390950400000000,...
                -6958373/27415392599317650157764091422313673696374638300364800000000,...
                253009/32898471119181180189316909706776408435649565960437760000000000,...
                -101/1105388629604487654361048166147687323437825416270708736000000000,...
                1/5593266465798707531066903720707297856595396606329786204160000000000];
            p2 = [1, -83/516, 134303/18194160, -151805/993401136, 944319949/542516228392320,...
                -2907714977/238707140492620800, 2089317511/37238313916848844800,...
                -10791353051/60605355899671494912000,...
                101503414427/252686239306493197414809600,...
                -100343508571/152503577369683541498585088000,...
                4318528675729/5444377712097702431499487641600000,...
                -22709281687/32033199096760900352776055193600000,...
                7077025632431/15041508967875048369649524476706816000000,...
                -200084526553/866390916549602786091812609858312601600000,...
                312006366041/3760136577825276091638466726785076690944000000,...
                -151149637/7050256083422392671822125112722018795520000000,...
                3345677791/863628169194909412727523037807996414376017920000000,...
                -964705507/2055435042683884402291504829983031466214922649600000000,...
                1585799/44397396921971903089496504327633479670242329231360000000,...
                -252509/164492355595905900946584548533882042178247829802188800000000,...
                1009/32898471119181180189316909706776408435649565960437760000000000,...
                -1/5526943148022438271805240830738436617189127081353543680000000000];
            q = [ 1, 1/172, 21/1212944, 5/141914448, 95/1722273740928, 19/267909248588800,...
                323/4137590435205427200, 17/224464281109894425600, 17/256906851872977833246720,...
                17/321060162883544297891758080, 17/432196373112463477931212800000,...
                1/36448560799151086638865612800000, 1/55110223928316442997964806553600000,...
                1/87118241985882633091182766199930880000,...
                1/142835197638187125988165877560686673920000,...
                1/241034396014440775105029918383658762240000000,...
                1/415405564788316215838154419340065615380480000000,...
                1/725021179077207902042858846554861187377397760000000,...
                1/1268497054913482945414185837932385133435495120896000000,...
                1/2193231407945412012621127313785093895709971064029184000000,...
                1/3655385679909020021035212189641823159516618440048640000000000,...
                1/5526943148022438271805240830738436617189127081353543680000000000,...
                1/5593266465798707531066903720707297856595396606329786204160000000000];
            Tpowers{14} = Tpowers{6}*Tpowers{8}; Tpowers{16} = Tpowers{8}^2;
            Tpowers{18} = Tpowers{8}*Tpowers{10}; Tpowers{20} = Tpowers{10}^2;
            Tpowers{22} = Tpowers{10}*Tpowers{12};
            P = p(1)*I + p(2)*Tpowers{2} + p(3)*Tpowers{4} + p(4)*Tpowers{6} +...
                p(5)*Tpowers{8} + p(6)*Tpowers{10} + p(7)*Tpowers{12} + p(8)*Tpowers{14} +...
                p(9)*Tpowers{16} + p(10)*Tpowers{18} + p(11)*Tpowers{20} + p(12)*Tpowers{22} +...
                Tpowers{22}*(p(13)*Tpowers{2} + p(14)*Tpowers{4} + p(15)*Tpowers{6} + ...
                p(16)*Tpowers{8} + p(17)*Tpowers{10} + p(18)*Tpowers{12} + p(19)*Tpowers{14}+...
                p(20)*Tpowers{16} + p(21)*Tpowers{18} + p(22)*Tpowers{20} + p(23)*Tpowers{22});
            P2 = T*( p2(1)*I + p2(2)*Tpowers{2} + p2(3)*Tpowers{4} + p2(4)*Tpowers{6} +...
                p2(5)*Tpowers{8} + p2(6)*Tpowers{10} + p2(7)*Tpowers{12} +...
                p2(8)*Tpowers{14} + p2(9)*Tpowers{16} + p2(10)*Tpowers{18} +...
                p2(11)*Tpowers{20} + p2(12)*Tpowers{22} +...
                Tpowers{22}*(p2(13)*Tpowers{2} + p2(14)*Tpowers{4} + p2(15)*Tpowers{6} +...
                p2(16)*Tpowers{8} + p2(17)*Tpowers{10} + p2(18)*Tpowers{12} +...
                p2(19)*Tpowers{14} + p2(20)*Tpowers{16} + p2(21)*Tpowers{18} +...
                p2(22)*Tpowers{20}) );
            R = q(1)*I + q(2)*Tpowers{2} + q(3)*Tpowers{4} + q(4)*Tpowers{6} +...
                q(5)*Tpowers{8} + q(6)*Tpowers{10} + q(7)*Tpowers{12} + q(8)*Tpowers{14} +...
                q(9)*Tpowers{16} + q(10)*Tpowers{18} + q(11)*Tpowers{20} + q(12)*Tpowers{22} + ...
                Tpowers{22}*(q(13)*Tpowers{2} + q(14)*Tpowers{4} + q(15)*Tpowers{6} + ...
                q(16)*Tpowers{8} + q(17)*Tpowers{10} + q(18)*Tpowers{12} + q(19)*Tpowers{14} +...
                q(20)*Tpowers{16} + q(21)*Tpowers{18} + q(22)*Tpowers{20} + q(23)*Tpowers{22});
    end
    [L, U] = lu(R);
    X = U\(L\P);
    Y = U\(L\P2);

end % of rational_approx


function Y = recompute_blocks_cos(pos, depth, T)
% RECOMPUTE_BLOCKS_COS Recomputes a 2x2 diagonal block of the matrix.
%
% This function is called by recompute_diag to recompute the 2x2 diagonal
% blocks of a (quasi-)triangular matrix cosine to high accuracy.
% This generally increases the accuracy of the overall computation for
% nonnormal matrices.
    Y = 2^depth * T(pos:pos+1, pos:pos+1);
    if Y(2,1) == 0
        % Upper-tri block
        if Y(1,1) ~= Y(2,2)
            evalp = (Y(1,1) + Y(2,2))/2; evalm = (Y(1,1) - Y(2,2))/2;
            Y = [cos(Y(1,1))  -Y(1,2)*(sin(evalp)*sin(evalm))/evalm
                 0            cos(Y(2,2))];
        else
            Y = [cos(Y(1,1)) -Y(1,2)*sin(Y(1,1))
                 0           cos(Y(2,2))];
        end
    else
        % 2x2 block
        th = sqrt(-Y(1,2)*Y(2,1));
        Y = [cos(Y(1,1))*cosh(th)         -Y(1,2)*sin(Y(1,1))*sinh(th)/th
             -Y(2,1)*sin(Y(1,1))*sinh(th)/th   cos(Y(2,2))*cosh(th)];
    end
end % of recompute_blocks_cos


function Y = recompute_blocks_sin(pos, depth, T)
% RECOMPUTE_BLOCKS_SIN Recomputes a 2x2 diagonal block of the matrix.
%
% This function is called by recompute_diag to recompute the 2x2 diagonal
% blocks of a (quasi-)triangular matrix sine to high accuracy.
% This generally increases the accuracy of the overall computation for
% nonnormal matrices.
    Y = 2^depth * T(pos:pos+1, pos:pos+1);
    if isequal(Y, triu(Y))
        % Upper-tri block
        l1 = Y(1,1); l2 = Y(2,2); y = Y(1,2);
        if l1 == l2
            Y = [sin(l1) y*cos(l1)
                 0        sin(l2)];
        else 
            Y = [sin(l1) y*(sin((l1-l2)/2)*cos((l1+l2)/2))/((l1-l2)/2)
                0        sin(l2)];
        end
        
    else
        % 2x2 block
        th = sqrt(-Y(1,2)*Y(2,1));
        Y = [sin(Y(1,1))*cosh(th)         Y(1,2)*cos(Y(1,1))*sinh(th)/th
             Y(2,1)*cos(Y(1,1))*sinh(th)/th   sin(Y(2,2))*cosh(th)];
    end
end % of recompute_blocks_sin


function C = recompute_diag_cos(C, T, depth)
% RECOMPUTE_DIAG_COS Recompute the 2x2 diagonal blocks of C to high accuracy.
%
% This function uses an explicit formula for the matrix cosine of a 2x2
% matrix to accurately form the diagonal blocks of the (quasi-)triangular
% matrix C. This generally increases the accuracy of the overall
% computation for nonnormal matrices.
    j = 1;
    n = length(T);
    while j <= n-1
        if T(j+1,j) ~= 0
            C(j:j+1,j:j+1) = recompute_blocks_cos(j, depth, T);
            j = j + 2; %Ignore next part of Schur block
        elseif j <= n-2 && T(j+2, j+1) ~= 0
            %Next block is Schur block so leave it
            j = j + 1;
        else
            C(j:j+1,j:j+1) = recompute_blocks_cos(j, depth, T);
            j = j + 1; %On upper tri block so move to next bit
        end
    end
end % of recompute_diag_cos


function S = recompute_diag_sin(S, T, depth)
% RECOMPUTE_DIAG_SIN Recompute the 2x2 diagonal blocks of S to high accuracy.
%
% This function uses an explicit formula for the matrix sine of a 2x2
% matrix to accurately form the diagonal blocks of the (quasi-)triangular
% matrix S. This generally increases the accuracy of the overall
% computation for nonnormal matrices.
    j = 1;
    n = length(T);
    while j <= n-1
        if T(j+1,j) ~= 0
            S(j:j+1,j:j+1) = recompute_blocks_sin(j, depth, T);
            j = j + 2; %Ignore next part of Schur block
        elseif j <= n-2 && T(j+2, j+1) ~= 0
            %Next block is Schur block so leave it
            j = j + 1;
        else
            S(j:j+1,j:j+1) = recompute_blocks_sin(j, depth, T);
            j = j + 1; %On upper tri block so move to next bit
        end
    end
end % of recompute_diag_sin
